(function(){var slice=[].slice;this.Kreal=function(){Kreal.prototype.events={};Kreal.prototype.models={};function Kreal(server){this.server=server!=null?server:"ws://"+location.host}Kreal.prototype.connect=function(onconnect){this.onconnect=onconnect;this.socket=new WebSocket(this.server+"/kreal");this.socket.onopen=function(_this){return function(){return _this.socket.send("fetch:fetcher:[]")}}(this);this.socket.onmessage=function(_this){return function(event){return _this.onmessage(event)}}(this);this.socket.onclose=function(_this){return function(){return _this.connect(_this.onconnect)}}(this);return null};Kreal.prototype.onmessage=function(event){var _caller,fn,i,json,len,method,model,ref,ref1;json=JSON.parse(event.data);if(json.fetch!=null){ref=json.fetch;fn=function(_this){return function(model,method){var base;if((base=_this.models)[model]==null){base[model]={}}_this.models[model][method]=function(){var args,callback,id,j,message;args=2<=arguments.length?slice.call(arguments,0,j=arguments.length-1):(j=0,[]),callback=arguments[j++];if(callback==null){callback=function(){}}if(typeof arguments[0]==="function"){callback=arguments[0];args=[]}message={model:model,method:method,args:args};id=(Math.random()*1e18).toString(16);_this.events[id]=callback;return _this.socket.send("call:"+id+":"+JSON.stringify(message))};return typeof _this.onconnect==="function"?_this.onconnect(_this.models):void 0}}(this);for(i=0,len=ref.length;i<len;i++){_caller=ref[i];model=_caller[0],method=_caller[1];fn(model,method)}}if(json.call!=null){if((ref1=this.events[json.id])!=null){ref1.call(null,json.call.result)}return delete this.events[json.id]}};return Kreal}()}).call(this);